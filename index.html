<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Stok Gudang Divisi PP ‚Äî Dashboard</title>

  <!-- Content Security Policy (sesuaikan domain jika perlu) -->
  <meta http-equiv="Content-Security-Policy"
        content="default-src 'self';
                 img-src 'self' data: https:;
                 style-src 'self' 'unsafe-inline' https://cdn.tailwindcss.com;
                 script-src 'self' https://www.gstatic.com https://www.googletagmanager.com https://cdn.tailwindcss.com https://cdn.jsdelivr.net https://unpkg.com 'unsafe-inline';
                 connect-src 'self' https://firestore.googleapis.com https://www.googleapis.com https://www.gstatic.com https://securetoken.googleapis.com https://identitytoolkit.googleapis.com;
                 font-src 'self' data: https:;
                 frame-src https://www.google.com https://www.gstatic.com;">
  <meta name="referrer" content="no-referrer" />

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Icons (Lucide) -->
  <script src="https://unpkg.com/lucide@latest"></script>

  <!-- SheetJS for Excel Export -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <!-- Chart.js for Analytics -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    :root {
      --bg: #0b1220;
      --panel: #0f172a;
      --muted: #94a3b8;
    }
    body { background: var(--bg); color: #e2e8f0; }
    .chip { background:#eef2ff; color:#3730a3; padding:2px 8px; border-radius:999px; font-size:12px; }
    .glass { background: rgba(15, 23, 42, 0.8); backdrop-filter: blur(10px); }
    .card { background: var(--panel); border: 1px solid rgba(148,163,184,0.15); }
    .btn { display:inline-flex; align-items:center; gap:.5rem; padding:.6rem .9rem; border-radius:.7rem; }
    .btn-primary { background:#2563eb; color:white; }
    .btn-danger { background:#ef4444; color:white; }
    .btn-ghost { background:#0b1220; color:#cbd5e1; border:1px solid rgba(148,163,184,0.2); }
    .badge { font-size:.7rem; padding:.15rem .5rem; border-radius:999px; border:1px solid rgba(148,163,184,.25); }
    .low { color:#ef4444; }
    .warn { color:#f59e0b; }
    .ok { color:#10b981; }
    .sticky-sentinel { height: 1px; }
  </style>
</head>
<body class="min-h-screen">
  <!-- Notifications -->
  <div id="notif" class="fixed top-4 right-4 z-50 space-y-2"></div>

  <!-- AUTH -->
  <section id="authSection" class="min-h-screen flex items-center justify-center p-4">
    <div class="w-full max-w-md card rounded-2xl p-6">
      <div class="text-center mb-4">
        <div class="mx-auto w-12 h-12 rounded-xl bg-blue-600/20 flex items-center justify-center mb-2">
          <svg width="26" height="26" viewBox="0 0 24 24" fill="none" class="text-blue-400">
            <path d="M3 7h18M3 12h18M3 17h18" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          </svg>
        </div>
        <h1 class="text-xl font-bold">Stok Gudang Divisi PP</h1>
        <p class="text-sm text-slate-400">Silakan login untuk mengakses data.</p>
      </div>

      <div class="grid grid-cols-2 gap-2 mb-4">
        <button id="tabLogin" class="py-2 rounded-lg btn-primary font-medium">Login</button>
        <button id="tabRegister" class="py-2 rounded-lg btn-ghost font-medium">Register</button>
      </div>

      <form id="loginForm" class="space-y-3" autocomplete="off">
        <input id="loginEmail" type="email" placeholder="Email" required
               class="w-full border border-slate-700 bg-slate-900 rounded-lg px-3 py-2" />
        <input id="loginPassword" type="password" placeholder="Password" required
               class="w-full border border-slate-700 bg-slate-900 rounded-lg px-3 py-2" />
        <div class="flex gap-2">
          <button type="submit" class="flex-1 rounded-lg btn-primary">Masuk</button>
          <button id="googleSignInBtn" type="button" class="flex-1 rounded-lg btn-ghost">
            <svg width="18" height="18" viewBox="0 0 48 48"><path fill="#FFC107" d="M43.6 20.5H42V20H24v8h11.3C33.7 32.5 29.3 36 24 36c-6.6 0-12-5.4-12-12s5.4-12 12-12c3 0 5.7 1.1 7.7 2.9l5.7-5.7C33.1 6.1 28.8 4 24 4 12.9 4 4 12.9 4 24s8.9 20 20 20c10 0 18.5-7.3 19.9-16.8.1-.7.1-1.4.1-2.1 0-1.2-.1-2.3-.4-3.6z"/><path fill="#FF3D00" d="M6.3 14.7l6.6 4.8C14.7 16 19 12 24 12c3 0 5.7 1.1 7.7 2.9l5.7-5.7C33.1 6.1 28.8 4 24 4 16.3 4 9.7 8.4 6.3 14.7z"/><path fill="#4CAF50" d="M24 44c5.3 0 10.1-2 13.7-5.3l-6.3-5.2C29.4 35.5 26.9 36 24 36c-5.2 0-9.6-3.5-11.5-8.3l-6.5 5C8.6 39.5 15.8 44 24 44z"/><path fill="#1976D2" d="M43.6 20.5H42V20H24v8h11.3c-1.3 3-4.9 5.3-11.3 5.3-6.6 0-12-5.4-12-12s5.4-12 12-12c3 0 5.7 1.1 7.7 2.9l5.7-5.7C33.1 6.1 28.8 4 24 4 12.9 4 4 12.9 4 24s8.9 20 20 20c10 0 18.5-7.3 19.9-16.8.1-.7.1-1.4.1-2.1 0-1.2-.1-2.3-.4-3.6z"/></svg>
            Google
          </button>
        </div>
        <p id="loginError" class="text-sm text-rose-400 hidden"></p>
      </form>

      <form id="registerForm" class="space-y-3 hidden" autocomplete="off">
        <input id="regName" type="text" placeholder="Nama lengkap" minlength="3" required
               class="w-full border border-slate-700 bg-slate-900 rounded-lg px-3 py-2" />
        <input id="regEmail" type="email" placeholder="Email" required
               class="w-full border border-slate-700 bg-slate-900 rounded-lg px-3 py-2" />
        <input id="regPassword" type="password" placeholder="Password (min 6)" minlength="6" required
               class="w-full border border-slate-700 bg-slate-900 rounded-lg px-3 py-2" />
        <button id="registerBtn" type="submit" class="w-full rounded-lg btn-primary">Daftar</button>
        <p id="regError" class="text-sm text-rose-400 hidden"></p>
      </form>

      <p class="text-xs text-slate-500 text-center mt-4">
        Admin ditentukan oleh daftar <code>ADMIN_EMAILS</code> pada file ini.
      </p>
    </div>
  </section>

  <!-- APP -->
  <section id="appSection" class="hidden">
    <!-- Header -->
    <header class="sticky top-0 z-30 glass border-b border-slate-800">
      <div class="max-w-7xl mx-auto px-4 py-3 flex items-center justify-between">
        <div class="flex items-center gap-3">
          <div class="w-9 h-9 rounded-lg bg-blue-600/20 flex items-center justify-center">
            <i data-lucide="boxes" class="w-5 h-5 text-blue-400"></i>
          </div>
          <div>
            <h2 class="text-lg font-semibold">Stok Gudang Divisi PP</h2>
            <div id="userInfo" class="text-xs text-slate-400"></div>
          </div>
        </div>
        <div class="flex items-center gap-3">
          <span id="roleBadge" class="chip">User</span>
          <button id="logoutBtn" class="btn btn-danger">Logout</button>
        </div>
      </div>
    </header>

    <div class="max-w-7xl mx-auto px-4 py-6 grid grid-cols-1 lg:grid-cols-12 gap-6">
      <!-- Sidebar -->
      <aside class="lg:col-span-3 card rounded-2xl p-4 h-max">
        <h3 class="text-sm font-semibold text-slate-300 mb-3">Navigasi</h3>
        <nav class="space-y-2">
          <a href="#produk" class="block px-3 py-2 rounded-lg hover:bg-slate-800">üì¶ Produk</a>
          <a href="#analitik" class="block px-3 py-2 rounded-lg hover:bg-slate-800">üìà Analitik</a>
          <a href="#riwayat" class="block px-3 py-2 rounded-lg hover:bg-slate-800">üïò Riwayat</a>
          <a href="#export" class="block px-3 py-2 rounded-lg hover:bg-slate-800">‚¨áÔ∏è Export</a>
        </nav>

        <div id="adminPanel" class="mt-6 hidden">
          <h3 class="text-sm font-semibold text-slate-300 mb-3">üõ†Ô∏è Kelola Stok (Admin)</h3>
          <form id="manageForm" class="space-y-3">
            <div>
              <label class="text-xs text-slate-400">Nama Produk</label>
              <input id="inputNama" class="w-full border border-slate-700 bg-slate-900 rounded px-3 py-2" required />
            </div>
            <div>
              <label class="text-xs text-slate-400">Kategori</label>
              <input id="inputKategori" class="w-full border border-slate-700 bg-slate-900 rounded px-3 py-2" required />
            </div>
            <div class="grid grid-cols-2 gap-2">
              <div>
                <label class="text-xs text-slate-400">Jumlah (+ / tambah)</label>
                <input id="inputJumlah" type="number" min="1" max="1000000" class="w-full border border-slate-700 bg-slate-900 rounded px-3 py-2" required />
              </div>
              <div>
                <label class="text-xs text-slate-400">Stok minimal</label>
                <input id="inputMinStock" type="number" min="0" max="1000000" class="w-full border border-slate-700 bg-slate-900 rounded px-3 py-2" />
              </div>
            </div>

            <div class="grid grid-cols-2 gap-2">
              <button type="submit" data-action="add" class="btn btn-primary justify-center">Tambah / Buat</button>
              <button type="button" id="subtractBtn" class="btn btn-danger justify-center">Kurangi</button>
            </div>

            <div class="flex gap-2 mt-2">
              <button id="editSelectedBtn" type="button" class="btn btn-ghost flex-1 justify-center text-sm">Edit Terpilih</button>
              <button id="deleteSelectedBtn" type="button" class="btn btn-ghost flex-1 justify-center text-sm">Hapus Terpilih</button>
            </div>
            <p id="manageMsg" class="text-sm text-rose-400 hidden"></p>
          </form>
        </div>
      </aside>

      <!-- Main content -->
      <main class="lg:col-span-9 space-y-6">

        <!-- Produk -->
        <section id="produk" class="card rounded-2xl p-5">
          <div class="flex flex-col md:flex-row justify-between gap-3 mb-4">
            <div>
              <h3 class="font-semibold text-lg">üìã Daftar Produk</h3>
              <p class="text-xs text-slate-400">Realtime + Pagination & infinite scroll</p>
            </div>
            <div class="flex gap-2 items-center">
              <input id="searchBox" placeholder="Cari produk..." class="border border-slate-700 bg-slate-900 rounded px-3 py-2" />
              <select id="categoryFilter" class="border border-slate-700 bg-slate-900 rounded px-3 py-2">
                <option value="all">Semua Kategori</option>
              </select>
              <button id="refreshBtn" class="btn btn-ghost">Refresh</button>
            </div>
          </div>

          <!-- Header (desktop) -->
          <div class="hidden md:grid grid-cols-12 text-xs uppercase text-slate-400 bg-slate-900/50 px-4 py-2 rounded-t-lg">
            <div class="col-span-5">Produk</div>
            <div class="col-span-3">Kategori</div>
            <div class="col-span-2 text-right">Stok</div>
            <div class="col-span-2 text-center">Aksi</div>
          </div>

          <!-- Container + infinite scroll sentinel -->
          <div id="productsContainer" class="max-h-[28rem] overflow-y-auto divide-y divide-slate-800">
            <!-- rows injected -->
            <div id="infiniteSentinelTop" class="sticky-sentinel"></div>
            <div id="infiniteSentinelBottom" class="sticky-sentinel"></div>
          </div>

          <div class="mt-3 flex justify-center">
            <button id="loadMoreBtn" class="btn btn-ghost">Muat Lagi</button>
          </div>
          <p id="pagingInfo" class="text-xs text-slate-400 mt-2"></p>
        </section>

        <!-- Analitik -->
        <section id="analitik" class="card rounded-2xl p-5">
          <div class="flex items-center justify-between mb-3">
            <div>
              <h3 class="font-semibold text-lg">üìà Analitik Stok per Kategori</h3>
              <p class="text-xs text-slate-400">Terupdate otomatis dari data produk</p>
            </div>
            <button id="refreshChartBtn" class="btn btn-ghost">Refresh Grafik</button>
          </div>
          <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <div class="p-4 rounded-xl bg-slate-900/40 border border-slate-800">
              <h4 class="font-medium mb-2">Bar</h4>
              <canvas id="barChart" height="140"></canvas>
            </div>
            <div class="p-4 rounded-xl bg-slate-900/40 border border-slate-800">
              <h4 class="font-medium mb-2">Doughnut</h4>
              <canvas id="pieChart" height="140"></canvas>
            </div>
          </div>
        </section>

        <!-- Riwayat -->
        <section id="riwayat" class="card rounded-2xl p-5">
          <div class="flex flex-col md:flex-row justify-between gap-3 mb-4 items-center">
            <div>
              <h3 class="font-semibold text-lg">üïò Riwayat Perubahan</h3>
              <p class="text-xs text-slate-400">Catatan semua perubahan (admin & sistem)</p>
            </div>
            <div class="flex gap-2 items-center">
              <button class="filterQuick btn btn-ghost" data-days="7">7 Hari</button>
              <button class="filterQuick btn btn-ghost" data-days="30">30 Hari</button>
              <input id="historyDate" type="date" class="border border-slate-700 bg-slate-900 rounded px-3 py-2" />
              <button id="historyReset" class="btn btn-ghost">Reset</button>
            </div>
          </div>

          <div class="hidden md:grid grid-cols-12 text-xs uppercase text-slate-400 bg-slate-900/50 px-4 py-2 rounded-t-lg">
            <div class="col-span-3">Waktu</div>
            <div class="col-span-3">Produk</div>
            <div class="col-span-2">Kategori</div>
            <div class="col-span-2 text-right">Jumlah</div>
            <div class="col-span-2 text-right">Petugas</div>
          </div>
          <div id="historyContainer" class="max-h-[28rem] overflow-y-auto divide-y divide-slate-800 text-sm">
            <!-- filled by JS -->
          </div>
        </section>

        <!-- Export -->
        <section id="export" class="card rounded-2xl p-5">
          <h3 class="font-semibold text-lg mb-3">‚¨áÔ∏è Export</h3>
          <p class="text-sm text-slate-400 mb-4">Unduh data produk & riwayat sebagai CSV atau Excel.</p>
          <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
            <div class="p-4 rounded-xl bg-slate-900/40 border border-slate-800">
              <h4 class="font-medium mb-2">Produk</h4>
              <div class="flex flex-wrap gap-2">
                <button id="exportProductsCsv" class="btn btn-ghost">Export CSV</button>
                <button id="exportProductsXlsx" class="btn btn-primary">Export Excel</button>
              </div>
            </div>
            <div class="p-4 rounded-xl bg-slate-900/40 border border-slate-800">
              <h4 class="font-medium mb-2">Riwayat</h4>
              <div class="flex flex-wrap gap-2">
                <button id="exportHistoryCsv" class="btn btn-ghost">Export CSV</button>
                <button id="exportHistoryXlsx" class="btn btn-primary">Export Excel</button>
              </div>
            </div>
          </div>
        </section>
      </main>
    </div>
  </section>

  <!-- App Script -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import {
      getAuth, setPersistence, browserLocalPersistence,
      signInWithEmailAndPassword, createUserWithEmailAndPassword,
      signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged, updateProfile
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import {
      initializeAppCheck, ReCaptchaV3Provider
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app-check.js";
    import {
      getFirestore, collection, doc, setDoc, updateDoc, deleteDoc,
      runTransaction, addDoc, serverTimestamp, query, orderBy, onSnapshot
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // ===== Firebase Config (punya Anda) =====
    const firebaseConfig = {
      apiKey: "AIzaSyCk_9zFTS5CRgmIcuswG_gvpLVWx2PcF58",
      authDomain: "stok-gudang-divisi-pp.firebaseapp.com",
      projectId: "stok-gudang-divisi-pp",
      storageBucket: "stok-gudang-divisi-pp.firebasestorage.app",
      messagingSenderId: "838303987838",
      appId: "1:838303987838:web:e16829f449925469ae002f",
      measurementId: "G-QYH5LD18NT"
    };

    // ===== Init =====
    const app = initializeApp(firebaseConfig);

    // App Check (ISI SITE KEY ANDA)
    initializeAppCheck(app, {
      provider: new ReCaptchaV3Provider("YOUR_RECAPTCHA_V3_SITE_KEY"),
      isTokenAutoRefreshEnabled: true
    });

    const auth = getAuth(app);
    await setPersistence(auth, browserLocalPersistence);
    const db = getFirestore(app);
    const googleProvider = new GoogleAuthProvider();

    // ===== Admins =====
    const ADMIN_EMAILS = ["reyhanmuhamadrizki1@gmail.com"];

    // ===== Utils =====
    const $ = (id) => document.getElementById(id);
    const notif = (msg, ok = true) => {
      const container = $('notif');
      const el = document.createElement('div');
      el.className = `p-2 rounded-lg shadow text-sm ${ok ? 'bg-emerald-100 text-emerald-900' : 'bg-rose-100 text-rose-900'}`;
      el.textContent = msg;
      container.appendChild(el);
      setTimeout(() => el.remove(), 3500);
    };
    const escapeHtml = (s) => String(s || '').replace(/[&<>"']/g, (m)=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]));

    // ===== DOM =====
    const authSection = $('authSection');
    const appSection = $('appSection');

    const tabLogin = $('tabLogin');
    const tabRegister = $('tabRegister');
    const loginForm = $('loginForm');
    const registerForm = $('registerForm');
    const loginError = $('loginError');
    const regError = $('regError');
    const googleSignInBtn = $('googleSignInBtn');

    const adminPanel = $('adminPanel');
    const manageForm = $('manageForm');
    const subtractBtn = $('subtractBtn');
    const editSelectedBtn = $('editSelectedBtn');
    const deleteSelectedBtn = $('deleteSelectedBtn');

    const productsContainer = $('productsContainer');
    const pagingInfo = $('pagingInfo');
    const loadMoreBtn = $('loadMoreBtn');
    const sentinelBottom = $('infiniteSentinelBottom');
    const searchBox = $('searchBox');
    const categoryFilter = $('categoryFilter');
    const refreshBtn = $('refreshBtn');

    const userInfo = $('userInfo');
    const roleBadge = $('roleBadge');
    const logoutBtn = $('logoutBtn');

    const exportProductsCsv = $('exportProductsCsv');
    const exportProductsXlsx = $('exportProductsXlsx');
    const exportHistoryCsv = $('exportHistoryCsv');
    const exportHistoryXlsx = $('exportHistoryXlsx');

    const refreshChartBtn = $('refreshChartBtn');

    // ===== Charts =====
    let barChart, pieChart;

    // ===== State =====
    let isAdmin = false;
    let productsCache = []; // { id, nama, kategori, jumlah, minStock }
    let historyCache = [];
    let selectedProductId = null;

    // Pagination / Infinite Scroll (client-side)
    const PAGE_SIZE = 30;
    let visibleCount = PAGE_SIZE;

    // ===== Auth Tab Switch =====
    tabLogin.addEventListener('click', () => {
      tabLogin.classList.add('btn-primary'); tabRegister.classList.remove('btn-primary'); tabRegister.classList.add('btn-ghost');
      loginForm.classList.remove('hidden'); registerForm.classList.add('hidden'); loginError.classList.add('hidden');
    });
    tabRegister.addEventListener('click', () => {
      tabRegister.classList.add('btn-primary'); tabLogin.classList.remove('btn-primary'); tabLogin.classList.add('btn-ghost');
      registerForm.classList.remove('hidden'); loginForm.classList.add('hidden'); regError.classList.add('hidden');
    });

    // ===== Auth Handlers =====
    loginForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      loginError.classList.add('hidden');
      const email = (document.getElementById('loginEmail').value || '').trim();
      const pass = document.getElementById('loginPassword').value;
      try {
        await signInWithEmailAndPassword(auth, email, pass);
      } catch (err) {
        loginError.textContent = `Login gagal: ${err.message}`;
        loginError.classList.remove('hidden');
      }
    });

    registerForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      regError.classList.add('hidden');
      const name = (document.getElementById('regName').value || '').trim();
      const email = (document.getElementById('regEmail').value || '').trim();
      const pass = document.getElementById('regPassword').value;
      try {
        const cred = await createUserWithEmailAndPassword(auth, email, pass);
        if (name) await updateProfile(cred.user, { displayName: name });
        notif('Registrasi berhasil. Anda sudah login.');
      } catch (err) {
        regError.textContent = `Registrasi gagal: ${err.message}`;
        regError.classList.remove('hidden');
      }
    });

    googleSignInBtn.addEventListener('click', async () => {
      try {
        await signInWithPopup(auth, googleProvider);
      } catch (err) {
        notif('Google sign-in gagal: ' + err.message, false);
      }
    });

    logoutBtn.addEventListener('click', async () => {
      await signOut(auth);
      notif('Anda sudah logout.');
    });

    // ===== Auth State =====
    onAuthStateChanged(auth, (user) => {
      if (user) {
        userInfo.textContent = user.displayName ? `${user.displayName} ‚Ä¢ ${user.email}` : user.email;
        isAdmin = ADMIN_EMAILS.includes(user.email || '');
        roleBadge.textContent = isAdmin ? 'Admin' : 'User';

        authSection.classList.add('hidden');
        appSection.classList.remove('hidden');
        adminPanel.classList.toggle('hidden', !isAdmin);

        attachRealtimeListeners();
      } else {
        authSection.classList.remove('hidden');
        appSection.classList.add('hidden');
        detachRealtimeListeners();
      }
      if (window.lucide) lucide.createIcons();
    });

    // ===== Firestore Realtime =====
    let unsubProducts = null;
    let unsubHistory = null;

    function attachRealtimeListeners(){
      const prodQuery = query(collection(db, 'produk'), orderBy('nama'));
      unsubProducts = onSnapshot(prodQuery, (snap) => {
        productsCache = snap.docs.map(d => ({ id: d.id, ...d.data() }));
        updateCategoryOptions();
        // jaga jumlah item terlihat saat ini
        renderProducts(); // akan pakai visibleCount
        updateCharts();
      });

      const histQuery = query(collection(db, 'riwayat'), orderBy('waktu', 'desc'));
      unsubHistory = onSnapshot(histQuery, (snap) => {
        historyCache = snap.docs.map(d => ({ id: d.id, ...d.data() }));
        renderHistory();
      });
    }

    function detachRealtimeListeners(){
      if (unsubProducts) { unsubProducts(); unsubProducts = null; }
      if (unsubHistory) { unsubHistory(); unsubHistory = null; }
      productsContainer.innerHTML = '';
      historyContainer.innerHTML = '';
      productsCache = [];
      historyCache = [];
      visibleCount = PAGE_SIZE;
    }

    // ===== Render Produk (with pagination) =====
    function stockClass(p){
      const cur = Number(p.jumlah || 0);
      const min = Number(p.minStock || 0);
      if (cur <= 0) return 'low';
      if (min > 0 && cur <= min) return 'warn';
      return 'ok';
    }

    function updateCategoryOptions(){
      const cats = Array.from(new Set(productsCache.map(p => p.kategori).filter(Boolean))).sort();
      const current = categoryFilter.value || 'all';
      categoryFilter.innerHTML = `<option value="all">Semua Kategori</option>` + cats.map(c => `<option value="${escapeHtml(c)}">${escapeHtml(c)}</option>`).join('');
      if (cats.includes(current)) categoryFilter.value = current;
    }

    function filteredRows(){
      const q = (searchBox.value || '').toLowerCase();
      const cat = categoryFilter.value || 'all';
      return productsCache
        .filter(p => (p.nama || '').toLowerCase().includes(q))
        .filter(p => cat === 'all' ? true : p.kategori === cat);
    }

    function renderProducts(){
      const rows = filteredRows();
      const slice = rows.slice(0, visibleCount);

      if (slice.length === 0) {
        productsContainer.innerHTML = `<div class="p-6 text-center text-slate-400">Tidak ada produk.</div>`;
        pagingInfo.textContent = '';
        return;
      }

      productsContainer.innerHTML = slice.map(p => {
        const cls = stockClass(p);
        const stok = Number(p.jumlah || 0);
        const min = Number(p.minStock || 0);
        return `
          <div class="grid grid-cols-12 px-4 py-3 items-center">
            <div class="col-span-12 md:col-span-5">
              <div class="font-medium">${escapeHtml(p.nama)}</div>
              <div class="text-xs text-slate-500">ID: ${escapeHtml(p.id)}</div>
            </div>
            <div class="col-span-6 md:col-span-3 text-sm mt-2 md:mt-0">${escapeHtml(p.kategori || '-')}</div>
            <div class="col-span-6 md:col-span-2 text-right font-semibold ${cls}">
              ${stok}
              ${min>0 ? `<span class="badge ml-2 text-slate-300">min ${min}</span>`:''}
            </div>
            <div class="col-span-12 md:col-span-2 text-center mt-2 md:mt-0">
              ${isAdmin ? `
                <button class="text-xs px-2 py-1 rounded bg-amber-200/20 border border-amber-300/30 mr-1 hover:bg-amber-200/30" data-action="quick-edit" data-id="${escapeHtml(p.id)}">Edit</button>
                <button class="text-xs px-2 py-1 rounded bg-rose-200/20 border border-rose-300/30 hover:bg-rose-200/30" data-action="quick-delete" data-id="${escapeHtml(p.id)}">Hapus</button>
              ` : `<span class="text-xs text-slate-500">‚Äî</span>`}
            </div>
          </div>
        `;
      }).join('');

      // Re-bind events for visible items
      productsContainer.querySelectorAll('[data-action="quick-edit"]').forEach(btn=>{
        btn.addEventListener('click', ()=> openEditProduct(btn.dataset.id));
      });
      productsContainer.querySelectorAll('[data-action="quick-delete"]').forEach(btn=>{
        btn.addEventListener('click', ()=> confirmAndDelete(btn.dataset.id));
      });

      // Paging info
      pagingInfo.textContent = `Menampilkan ${Math.min(visibleCount, rows.length)} dari ${rows.length} produk`;
      // Toggle "Muat Lagi"
      loadMoreBtn.disabled = visibleCount >= rows.length;
      loadMoreBtn.textContent = visibleCount >= rows.length ? 'Semua data ditampilkan' : 'Muat Lagi';
    }

    function loadMore(){
      const rows = filteredRows();
      if (visibleCount < rows.length) {
        visibleCount += PAGE_SIZE;
        renderProducts();
      }
    }

    // Infinite scroll: saat scroll mendekati bawah container
    productsContainer.addEventListener('scroll', () => {
      const nearBottom = productsContainer.scrollTop + productsContainer.clientHeight >= productsContainer.scrollHeight - 40;
      if (nearBottom) loadMore();
    });
    loadMoreBtn.addEventListener('click', loadMore);

    searchBox.addEventListener('input', () => { visibleCount = PAGE_SIZE; renderProducts(); });
    categoryFilter.addEventListener('change', () => { visibleCount = PAGE_SIZE; renderProducts(); });
    refreshBtn.addEventListener('click', () => { renderProducts(); renderHistory(); updateCharts(); notif('Refresh manual selesai'); });

    // ===== Render Riwayat =====
    function renderHistory(filtered = null){
      const list = (filtered || historyCache);
      const container = $('historyContainer');
      if (list.length === 0) {
        container.innerHTML = `<div class="p-6 text-center text-slate-400">Belum ada riwayat.</div>`;
        return;
      }
      container.innerHTML = list.map(r => {
        const t = r.waktu?.toDate ? r.waktu.toDate() : new Date();
        const plus = Number(r.jumlah||0) > 0;
        const jumlahStr = plus ? `+${r.jumlah}` : r.jumlah;
        return `
          <div class="grid grid-cols-12 px-4 py-3 items-center">
            <div class="col-span-12 md:col-span-3 text-slate-300">${escapeHtml(t.toLocaleString('id-ID'))}</div>
            <div class="col-span-6 md:col-span-3">${escapeHtml(r.nama)}</div>
            <div class="col-span-6 md:col-span-2">${escapeHtml(r.kategori || '-')}</div>
            <div class="col-span-6 md:col-span-2 text-right ${plus ? 'ok' : (Number(r.jumlah||0)<0 ? 'low' : '')}">${jumlahStr}</div>
            <div class="col-span-6 md:col-span-2 text-right text-slate-400">${escapeHtml(r.user || 'Anonim')}</div>
          </div>
        `;
      }).join('');
    }

    document.querySelectorAll('.filterQuick').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const days = parseInt(btn.dataset.days, 10);
        const now = new Date();
        const from = new Date(now);
        from.setDate(now.getDate() - days);
        const filtered = historyCache.filter(h => {
          const t = h.waktu?.toDate ? h.waktu.toDate() : new Date(0);
          return t >= from;
        });
        renderHistory(filtered);
      });
    });

    const historyDate = document.getElementById('historyDate');
    const historyReset = document.getElementById('historyReset');
    historyDate.addEventListener('change', () => {
      const val = historyDate.value;
      if(!val) return renderHistory();
      const filtered = historyCache.filter(h => {
        const t = h.waktu?.toDate ? h.waktu.toDate() : new Date(0);
        const yyyy = t.getFullYear();
        const mm = String(t.getMonth()+1).padStart(2,'0');
        const dd = String(t.getDate()).padStart(2,'0');
        return `${yyyy}-${mm}-${dd}` === val;
      });
      renderHistory(filtered);
    });
    historyReset.addEventListener('click', ()=> renderHistory());

    // ===== Manage Produk =====
    function normalizeId(name){
      return name.trim().toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/(^-|-$)/g,'');
    }

    manageForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      if(!isAdmin){ notif('Akses ditolak: hanya admin', false); return; }

      const action = e.submitter?.dataset?.action || 'add';
      const nama = document.getElementById('inputNama').value.trim();
      const kategori = document.getElementById('inputKategori').value.trim();
      const jumlah = parseInt(document.getElementById('inputJumlah').value,10);
      const minStock = parseInt(document.getElementById('inputMinStock').value || '0',10);
      const userEmail = auth.currentUser?.email || 'Anonim';

      // Validasi tambahan
      if(nama.length < 2 || kategori.length < 1 || !Number.isFinite(jumlah) || jumlah === 0 || jumlah > 1000000 || minStock < 0){
        document.getElementById('manageMsg').textContent = 'Periksa nama/kategori dan jumlah (1..1.000.000).';
        document.getElementById('manageMsg').classList.remove('hidden');
        return;
      }
      document.getElementById('manageMsg').classList.add('hidden');

      const id = normalizeId(nama);
      const prodRef = doc(db, 'produk', id);

      try {
        await runTransaction(db, async (t) => {
          const snap = await t.get(prodRef);
          if(snap.exists()){
            const cur = snap.data().jumlah || 0;

            if(action === 'subtract'){
              if(cur < Math.abs(jumlah)) throw new Error(`Stok saat ini ${cur} kurang dari perubahan ${jumlah}`);
              t.update(prodRef, { jumlah: cur - Math.abs(jumlah), kategori, minStock, updatedAt: serverTimestamp(), nama });
            } else {
              t.update(prodRef, { nama, kategori, jumlah: cur + jumlah, minStock, updatedAt: serverTimestamp() });
            }
          } else {
            if(action === 'subtract') throw new Error('Produk tidak ditemukan untuk dikurangi');
            t.set(prodRef, { nama, kategori, jumlah, minStock, createdAt: serverTimestamp(), updatedAt: serverTimestamp() });
          }
        });

        await addDoc(collection(db, 'riwayat'), {
          nama, kategori, jumlah: (action === 'subtract' ? -Math.abs(jumlah) : jumlah),
          user: userEmail, waktu: serverTimestamp()
        });

        notif('Operasi stok berhasil.');
        manageForm.reset();
      } catch(err){
        notif('Gagal: ' + err.message, false);
      }
    });

    subtractBtn.addEventListener('click', async () => {
      if(!isAdmin){ notif('Akses ditolak: hanya admin', false); return; }
      const nama = document.getElementById('inputNama').value.trim();
      const jumlah = parseInt(document.getElementById('inputJumlah').value,10);
      const kategori = document.getElementById('inputKategori').value.trim();
      if(!nama || !Number.isFinite(jumlah)){ notif('Isi nama dan jumlah untuk pengurangan', false); return; }
      const id = normalizeId(nama);
      const prodRef = doc(db, 'produk', id);
      try {
        await runTransaction(db, async (t) => {
          const snap = await t.get(prodRef);
          if(!snap.exists()) throw new Error('Produk tidak ditemukan');
          const cur = snap.data().jumlah || 0;
          if(cur < jumlah) throw new Error(`Stok tidak mencukupi (${cur})`);
          t.update(prodRef, { jumlah: cur - jumlah, updatedAt: serverTimestamp(), kategori, nama });
        });
        await addDoc(collection(db,'riwayat'), { nama, kategori, jumlah: -Math.abs(jumlah), user: auth.currentUser.email, waktu: serverTimestamp() });
        notif('Pengurangan stok berhasil.');
        manageForm.reset();
      } catch(err){
        notif('Gagal kurangi: '+err.message, false);
      }
    });

    function openEditProduct(docId){
      const p = productsCache.find(x => x.id === docId);
      if(!p) return notif('Produk tidak ditemukan', false);
      document.getElementById('inputNama').value = p.nama || '';
      document.getElementById('inputKategori').value = p.kategori || '';
      document.getElementById('inputJumlah').value = Math.abs(p.jumlah) || 0;
      document.getElementById('inputMinStock').value = p.minStock || '';
      selectedProductId = docId;
      notif(`Produk "${p.nama}" dimuat ke form (untuk edit).`);
    }

    async function confirmAndDelete(docId){
      if(!isAdmin) return notif('Akses ditolak', false);
      const ok = confirm('Yakin ingin menghapus produk ini? (riwayat akan tetap ada)');
      if(!ok) return;
      try {
        const p = productsCache.find(x => x.id === docId);
        await deleteDoc(doc(db, 'produk', docId));
        await addDoc(collection(db,'riwayat'), { nama: p?.nama || docId, kategori: p?.kategori || '', jumlah: 0, user: auth.currentUser.email, waktu: serverTimestamp(), aksi: 'delete' });
        notif('Produk dihapus.');
      } catch(err){
        notif('Gagal hapus: '+err.message, false);
      }
    }

    editSelectedBtn.addEventListener('click', async () => {
      if(!isAdmin) return notif('Akses ditolak', false);
      if(!selectedProductId) return notif('Belum ada produk terpilih untuk diedit', false);
      const nama = document.getElementById('inputNama').value.trim();
      const kategori = document.getElementById('inputKategori').value.trim();
      const minStock = parseInt(document.getElementById('inputMinStock').value || '0',10);
      try {
        await updateDoc(doc(db,'produk', selectedProductId), { nama, kategori, minStock, updatedAt: serverTimestamp() });
        await addDoc(collection(db,'riwayat'), { nama, kategori, jumlah: 0, user: auth.currentUser.email, waktu: serverTimestamp(), aksi:'edit' });
        notif('Produk diperbarui.');
        selectedProductId = null;
        manageForm.reset();
      } catch(err){
        notif('Gagal edit: '+err.message, false);
      }
    });

    deleteSelectedBtn.addEventListener('click', async () => {
      if(!isAdmin) return notif('Akses ditolak', false);
      if(!selectedProductId) return notif('Belum ada produk terpilih untuk dihapus', false);
      const ok = confirm('Yakin hapus produk terpilih?');
      if(!ok) return;
      try {
        const p = productsCache.find(p => p.id === selectedProductId);
        await deleteDoc(doc(db,'produk', selectedProductId));
        await addDoc(collection(db,'riwayat'), { nama: p?.nama||selectedProductId, kategori: p?.kategori||'', jumlah: 0, user: auth.currentUser.email, waktu: serverTimestamp(), aksi:'delete' });
        notif('Produk terhapus.');
        selectedProductId = null;
      } catch(err){
        notif('Gagal hapus: '+err.message, false);
      }
    });

    // ===== Export =====
    function toCsv(rows){
      if (!rows || rows.length === 0) return '';
      const headers = Object.keys(rows[0]);
      const escape = (v) => `"${String(v ?? '').replace(/"/g,'""')}"`;
      const lines = [headers.join(',')].concat(rows.map(r => headers.map(h => escape(r[h])).join(',')));
      return lines.join('\n');
    }
    function download(filename, content, type='text/csv'){
      const blob = new Blob([content], { type });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = filename; a.click();
      URL.revokeObjectURL(url);
    }
    function dateStamp(){
      const d = new Date();
      const yyyy = d.getFullYear();
      const mm = String(d.getMonth()+1).padStart(2,'0');
      const dd = String(d.getDate()).padStart(2,'0');
      const hh = String(d.getHours()).padStart(2,'0');
      const mi = String(d.getMinutes()).padStart(2,'0');
      return `${yyyy}${mm}${dd}_${hh}${mi}`;
    }

    exportProductsCsv.addEventListener('click', () => {
      const rows = productsCache.map(p => ({
        id: p.id, nama: p.nama, kategori: p.kategori || '', jumlah: Number(p.jumlah||0), minStock: Number(p.minStock||0)
      }));
      const csv = toCsv(rows);
      download(`produk_${dateStamp()}.csv`, csv, 'text/csv');
    });

    exportHistoryCsv.addEventListener('click', () => {
      const rows = historyCache.map(r => ({
        waktu: r.waktu?.toDate ? r.waktu.toDate().toISOString() : '',
        nama: r.nama || '', kategori: r.kategori || '',
        jumlah: Number(r.jumlah||0), user: r.user || '', aksi: r.aksi || ''
      }));
      const csv = toCsv(rows);
      download(`riwayat_${dateStamp()}.csv`, csv, 'text/csv');
    });

    exportProductsXlsx.addEventListener('click', () => {
      const rows = productsCache.map(p => ({
        ID: p.id, Nama: p.nama, Kategori: p.kategori || '', Stok: Number(p.jumlah||0), MinStock: Number(p.minStock||0)
      }));
      const wb = XLSX.utils.book_new();
      const ws = XLSX.utils.json_to_sheet(rows);
      XLSX.utils.book_append_sheet(wb, ws, 'Produk');
      XLSX.writeFile(wb, `produk_${dateStamp()}.xlsx`);
    });

    exportHistoryXlsx.addEventListener('click', () => {
      const rows = historyCache.map(r => ({
        Waktu: r.waktu?.toDate ? r.waktu.toDate().toLocaleString('id-ID') : '',
        Produk: r.nama || '', Kategori: r.kategori || '',
        Jumlah: Number(r.jumlah||0), Petugas: r.user || '', Aksi: r.aksi || ''
      }));
      const wb = XLSX.utils.book_new();
      const ws = XLSX.utils.json_to_sheet(rows);
      XLSX.utils.book_append_sheet(wb, ws, 'Riwayat');
      XLSX.writeFile(wb, `riwayat_${dateStamp()}.xlsx`);
    });

    // ===== Analytics (Chart.js) =====
    function groupByKategori(){
      const map = new Map();
      for (const p of productsCache) {
        const k = p.kategori || 'Tanpa Kategori';
        map.set(k, (map.get(k) || 0) + Number(p.jumlah || 0));
      }
      const labels = Array.from(map.keys()).sort();
      const data = labels.map(l => map.get(l));
      return { labels, data };
    }

    function updateCharts(){
      const { labels, data } = groupByKategori();

      const barCtx = document.getElementById('barChart');
      if (barChart) barChart.destroy();
      barChart = new Chart(barCtx, {
        type: 'bar',
        data: { labels, datasets: [{ label: 'Stok', data }] },
        options: {
          responsive: true,
          plugins: { legend: { display: false } },
          scales: { y: { beginAtZero: true } }
        }
      });

      const pieCtx = document.getElementById('pieChart');
      if (pieChart) pieChart.destroy();
      pieChart = new Chart(pieCtx, {
        type: 'doughnut',
        data: { labels, datasets: [{ label: 'Stok', data }] },
        options: { responsive: true, plugins: { legend: { position: 'bottom' } } }
      });
    }
    refreshChartBtn.addEventListener('click', updateCharts);

    $('productsContainer').innerHTML = `<div class="p-6 text-center text-slate-500">Memuat produk...</div>`;
    $('historyContainer').innerHTML = `<div class="p-6 text-center text-slate-500">Memuat riwayat...</div>`;

  </script>
</body>
</html>
 
